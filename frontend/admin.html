<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Million Pixels Admin</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
    background:#111;
    color:#fff;
    font-family:Segoe UI, Arial;
    margin:0;
    padding:20px;
}

.header{
    background:#000;
    padding:20px;
    border-radius:12px;
    border:1px solid #333;
    margin-bottom:20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.header h1{
    margin:0;
    color:#00e5b0;
}

.status-badge{
    font-size:12px;
    padding:4px 12px;
    border-radius:20px;
    background:#222;
    border:1px solid #333;
    display:flex;
    align-items:center;
    gap:6px;
}

.dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:red;
}

.online .dot{
    background:#00e5b0;
    box-shadow:0 0 8px #00e5b0;
}

.grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:15px;
}

.card{
    background:#0a0a0a;
    padding:20px;
    border-radius:12px;
    border:1px solid #222;
}

.big{
    font-size:28px;
}

.highlight{
    color:#00e5b0;
}

.list-container{
    margin-top:20px;
    background:#000;
    padding:20px;
    border-radius:12px;
    border:1px solid #222;
    max-height:600px;
    overflow-y:auto;
}

.item{
    background:#111;
    padding:12px;
    margin:10px 0;
    border-radius:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
}

.btn{
    padding:6px 14px;
    border:none;
    border-radius:6px;
    cursor:pointer;
}

.btn-delete{
    background:#ff4444;
    color:white;
}

.btn-delete:hover{
    background:#ff0000;
}

.btn-refresh{
    background:#333;
    color:white;
}

.btn-logout{
    background:transparent;
    border:1px solid red;
    color:red;
}
</style>
</head>

<body>

<div class="header">

<div>
<h1>Admin Dashboard</h1>

<div id="connectionStatus" class="status-badge">
<div class="dot"></div>
<span id="statusText">Connecting...</span>
</div>

</div>

<div>
<button class="btn btn-refresh" onclick="loadAnalytics()">Refresh</button>
<button class="btn btn-logout" onclick="logout()">Logout</button>
</div>

</div>

<div class="grid">

<div class="card">
<h3>Total Revenue</h3>
<div id="revenue" class="big highlight">₹0</div>
</div>

<div class="card">
<h3>Sold Pixels</h3>
<div id="sold" class="big">0</div>
</div>

<div class="card">
<h3>Available Pixels</h3>
<div id="available" class="big">0</div>
</div>

<div class="card">
<h3>Total Blocks</h3>
<div id="blocks" class="big">0</div>
</div>

</div>

<div class="list-container">

<button onclick="deleteAll()" 
style="background:red;color:white;padding:8px 14px;border:none;border-radius:6px;">
Delete All Blocks
</button>

<h3>Buyers History</h3>

<div id="buyers">
Loading...
</div>

</div>

<script>

/* ================= CONFIG ================= */

const API = "https://millionpixels.duckdns.org";

/* SET ADMIN KEY */
let adminKey = localStorage.getItem("adminKey");

/* AUTO SET if missing */
if(!adminKey){

    adminKey = "mahendr@9390";

    localStorage.setItem("adminKey", adminKey);
}

/* ================= SOCKET ================= */

const socket = io(API,{
    transports:["websocket","polling"],
    reconnection:true
});

const statusDiv = document.getElementById("connectionStatus");
const statusText = document.getElementById("statusText");

socket.on("connect",()=>{
    statusDiv.classList.add("online");
    statusText.innerText="Live Connected";
    loadAnalytics();
});

socket.on("disconnect",()=>{
    statusDiv.classList.remove("online");
    statusText.innerText="Offline";
});

socket.on("updated",()=>{
    loadAnalytics();
});

/* ================= LOAD ANALYTICS ================= */

async function loadAnalytics(){

try{

const res = await fetch(API+"/analytics",{

headers:{
"x-admin-key":adminKey
}

});

if(res.status===403){

alert("Invalid Admin Key");

logout();

return;
}

const data = await res.json();

/* UPDATE STATS */

document.getElementById("revenue").innerText =
"₹"+(data.totalRevenue||0).toLocaleString();

document.getElementById("sold").innerText =
(data.soldPixels||0).toLocaleString();

document.getElementById("available").innerText =
(data.availablePixels||0).toLocaleString();

document.getElementById("blocks").innerText =
(data.totalBlocks||0).toLocaleString();

/* UPDATE LIST */

const list=document.getElementById("buyers");

if(!data.blocks || data.blocks.length===0){

list.innerHTML="No buyers yet";

return;
}

let html="";

data.blocks.reverse().forEach((b,index)=>{

const px=b.width*b.height;

html+=`

<div class="item">

<div>

<b>${b.name}</b><br>

${px} px<br>

<a href="${b.link}" target="_blank">${b.link||""}</a>

</div>

<button class="btn btn-delete"
onclick="deleteBlock(${data.blocks.length-index-1})">

Delete

</button>

</div>

`;

});

list.innerHTML=html;

}catch(err){

console.error(err);

document.getElementById("buyers").innerHTML=

"Connection Failed";

}

}

/* ================= DELETE ================= */

async function deleteBlock(index){

if(!confirm("Delete this block?")) return;

const res=await fetch(API+"/delete-block",{

method:"POST",

headers:{
"Content-Type":"application/json",
"x-admin-key":adminKey
},

body:JSON.stringify({index:index})

});

const data=await res.json();

if(data.success){

loadAnalytics();

}else{

alert("Delete failed");

}

}

/* ================= LOGOUT ================= */

function logout(){

localStorage.removeItem("adminKey");

location.reload();

}

/* AUTO REFRESH */

setInterval(loadAnalytics,20000);


async function deleteAll(){

    if(!confirm("Are you sure you want to delete ALL blocks?")) return;

    const res = await fetch(API + "/delete-all-blocks", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "x-admin-key": adminKey
        }
    });

    const data = await res.json();

    if(data.success){
        loadAnalytics();
    } else {
        alert("Delete all failed");
    }
}
</script>

</body>
</html>
